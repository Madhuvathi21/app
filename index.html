<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gradebook ‚Äî Assignment & Course Portal (Local Demo)</title>
  <style>
    :root{
      --bg1:rgb(34, 100, 255);
      --bg2:#000000;
      --card:rgba(0, 0, 0, 0.08);
      --accent:#f8e9e9;
      --accent-2:#096c48;
      --muted:#e6e9ee;
      --glass:rgba(79, 33, 33, 0.05);
      --radius:12px;
      --maxw:1100px;
      --bg-image: url('https://images.unsplash.com/photo-1524758631624-e2822e304c36?auto=format&fit=crop&w=1920&q=80');
    }

    /* base */
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Arial;}
    html,body{height:100%;margin:0;color:#e2e4e7;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}

    body{
      background-color:var(--bg1);
      background-image: linear-gradient(135deg, rgba(0, 0, 0, 0.45), rgba(15,23,42,0.45)), var(--bg-image);
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height:100vh;
    }

    body::before{
      content:'';position:fixed;inset:0;pointer-events:none;
      background:radial-gradient(1200px 600px at 10% 10%, rgba(0,0,0,0.18), transparent 20%), linear-gradient(180deg, rgba(0,0,0,0.10), transparent 40%);
      mix-blend-mode:multiply;opacity:0.85;
    }

    /* container (note: -webkit- prefix placed BEFORE unprefixed) */
    .frame{
      max-width:var(--maxw);
      margin:28px auto;
      padding:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      -webkit-backdrop-filter: blur(10px) saturate(110%);
      backdrop-filter: blur(10px) saturate(110%);
      border-radius:16px;
      box-shadow:0 10px 40px rgba(0,0,0,0.45);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    header{display:flex;align-items:center;justify-content:space-between;padding:6px 12px;margin-bottom:14px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent),#2563eb);font-weight:700;color:#05204b}
    .app-name{font-size:1.35rem;font-weight:700}
    nav{display:flex;gap:8px;align-items:center}
    button{background:transparent;border:1px solid transparent;color:inherit;padding:8px 12px;border-radius:9px;cursor:pointer;font-weight:600; transition: background-color 0.2s; }
    button.primary{background:var(--accent);border-color:rgba(255,255,255,0.04);color:#05204b}
    button.ghost{background:transparent;border-color:rgba(255,255,255,0.04)}
    button.ghost:hover { background-color: rgba(255,255,255,0.1); transform: translateY(-1px); }

    .layout{display:flex;gap:18px}
    .sidebar{width:260px;min-width:200px;padding:14px;border-radius:12px;background:var(--card); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); }
    .main{flex:1;padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); }

    .card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px; border: 1px solid rgba(255, 255, 255, 0.1); }
    h2{margin:0 0 8px 0}
    .muted{color:var(--muted);font-size:0.92rem}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:inherit;margin-top:8px}
    textarea{min-height:100px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
    .icon-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.03);cursor:pointer;border:1px solid rgba(255,255,255,0.02); width: 100%; justify-content: flex-start;}
    .icon-btn:hover { background-color: rgba(255, 255, 255, 0.1); }

    .home-center{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:420px;gap:18px;text-align:center}
    .home-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .tiny{font-size:0.85rem;color:var(--muted)}
    .hidden{display:none!important}

    .layout.home .sidebar{display:none}
    .layout.home .main{flex:1 1 100%}

    /* role badges */
    .role-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700;font-size:0.85rem}
    .role-teacher{background: rgba(251,191,36,0.12); color:#fbbf24; border:1px solid rgba(251,191,36,0.14);}
    .role-student{background: rgba(52,211,153,0.08); color:#34d399; border:1px solid rgba(52,211,153,0.08);}

    /* small utility classes used instead of inline styles */
    .no-margin { margin: 0; }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-10 { margin-top: 10px; }
    .flex { display:flex; }
    .flex-col { display:flex; flex-direction:column; }
    .flex-center { display:flex; align-items:center; justify-content:center; }
    .flex-between { display:flex; justify-content:space-between; align-items:center; }
    .gap-8 { gap:8px; }
    .gap-12 { gap:12px; }
    .fw-700 { font-weight:700; }
    .small-note { font-size:0.82rem; color:var(--muted); }
    .dashed-hr { border:none; border-top:1px dashed rgba(255,255,255,0.03); margin:12px 0; }

    /* title helper used in home hero */
    .hero-title { font-size:28px; font-weight:800; color:var(--accent); }

    @media(max-width:900px){ .layout{flex-direction:column} .sidebar{width:100%} .home-center{min-height:260px} }
  </style>
</head>
<body>
  <div class="frame" role="application" aria-label="Gradebook Portal">
    <header>
      <div class="brand">
        <div class="logo">G</div>
        <div>
          <div class="app-name">Gradebook</div>
          <div class="tiny">Assignments ‚Ä¢ Courses ‚Ä¢ Marks ‚Äî local demo</div>
        </div>
      </div>

      <nav>
        <button id="nav-home" class="ghost">Home</button>
        <button id="nav-courses" class="ghost">Courses</button>
        <button id="nav-login" class="ghost">Login</button>
        <button id="nav-register" class="ghost">Register</button>
        <button id="nav-dashboard" class="primary hidden">Dashboard</button>
        <button id="nav-logout" class="ghost hidden">Logout</button>
      </nav>
    </header>

    <div class="layout">
      <aside class="sidebar" id="sidebar">
        <div class="card" id="signed-card">
          <!-- will be filled by JS via updateHeader() -->
          <div class="tiny">Signed in as</div>
          <div id="user-summary" class="mt-8"><div class="muted">Not signed in</div></div>
        </div>

        <div class="card">
          <h4 class="no-margin">Menu</h4>
          <div class="mt-10 flex-col gap-8">
            <button class="icon-btn" data-nav="home">üè† Home</button>
            <button class="icon-btn" data-nav="courses">üìö Courses</button>
            <button class="icon-btn" data-nav="dashboard">üìä Dashboard</button>
          </div>
        </div>

        <div class="card hidden" id="sidebar-quick">
          <h4 class="no-margin">Quick Actions</h4>
          <div class="mt-10 flex-col gap-8">
            <button id="sqa-create-course" class="icon-btn">‚ûï Create Course</button>
            <button id="sqa-create-assignment" class="icon-btn">‚ûï Create Assignment</button>
            <button id="sqa-view-submissions" class="icon-btn">üì• Submissions</button>
          </div>
          <div class="tiny mt-8">Visible only for teachers (not shown on Home).</div>
        </div>

        <div class="card">
          <h4 class="no-margin">Info</h4>
          <div class="tiny mt-8">Data is stored in <code>localStorage</code>. Files are saved as data URLs (demo only).</div>
        </div>
      </aside>

      <main class="main" id="main"></main>
    </div>
  </div>

<script>
/* -------------------------
  Local demo app ‚Äî updated:
  - Removed inline styles in static HTML and in generated templates (use CSS utility classes)
  - Added -webkit-backdrop-filter before backdrop-filter in CSS
  - Preserved all original logic and behavior
------------------------- */

const LS_KEYS = {
  users: 'assignly_users_v3',
  courses: 'assignly_courses_v3',
  assignments: 'assignly_assigns_v3',
  enrollments: 'assignly_enroll_v3',
  submissions: 'assignly_subs_v3',
  currentUser: 'assignly_current_v3'
};

function load(key){ return JSON.parse(localStorage.getItem(key) || '[]') }
function save(key, v){ localStorage.setItem(key, JSON.stringify(v)) }
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8) }
function fmt(ts){ return ts ? new Date(ts).toLocaleString() : '' }
function sanitize(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[<>]/g,'') }

let users = load(LS_KEYS.users);
let courses = load(LS_KEYS.courses);
let assignments = load(LS_KEYS.assignments);
let enrollments = load(LS_KEYS.enrollments);
let submissions = load(LS_KEYS.submissions);
let currentUser = JSON.parse(localStorage.getItem(LS_KEYS.currentUser) || 'null');

let currentView = 'home';

const main = document.getElementById('main');
const navHome = document.getElementById('nav-home');
const navCourses = document.getElementById('nav-courses');
const navLogin = document.getElementById('nav-login');
const navRegister = document.getElementById('nav-register');
const navDashboard = document.getElementById('nav-dashboard');
const navLogout = document.getElementById('nav-logout');
const sidebar = document.getElementById('sidebar');
const sidebarQuick = document.getElementById('sidebar-quick');
const userSummary = document.getElementById('user-summary');

navHome.addEventListener('click', () => renderHome());
navCourses.addEventListener('click', () => renderCourses());
navLogin.addEventListener('click', () => renderLogin());
navRegister.addEventListener('click', () => renderRegister());
navDashboard.addEventListener('click', () => { if(currentUser) renderDashboard(); else renderLogin(); });
navLogout.addEventListener('click', logout);

sidebar.addEventListener('click', (ev) => {
  const b = ev.target.closest('button[data-nav]');
  if(!b) return;
  const page = b.dataset.nav;
  if(page === 'home') renderHome();
  if(page === 'courses') renderCourses();
  if(page === 'dashboard') { if(currentUser) renderDashboard(); else renderLogin(); }
});

updateHeader();
renderHome();

async function sha256hex(msg){
  const enc = new TextEncoder(); const data = enc.encode(msg);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

function setCurrentUser(u){
  currentUser = u;
  if(u) localStorage.setItem(LS_KEYS.currentUser, JSON.stringify(u));
  else localStorage.removeItem(LS_KEYS.currentUser);
  updateHeader();
  updateSidebarQuickVisibility();
}

function updateHeader(){
  if(currentUser){
    // show colored role badge (use classes not inline styles)
    const roleClass = currentUser.role === 'Teacher' ? 'role-teacher' : 'role-student';
    userSummary.innerHTML = `<div class="fw-700">${sanitize(currentUser.email)}</div><div class="tiny mt-8"><span class="role-badge ${roleClass}">${sanitize(currentUser.role)}</span></div>`;
    navLogin.classList.add('hidden'); navRegister.classList.add('hidden');
    navDashboard.classList.remove('hidden'); navLogout.classList.remove('hidden');
  } else {
    userSummary.innerHTML = `<div class="muted">Not signed in</div>`;
    navLogin.classList.remove('hidden'); navRegister.classList.remove('hidden');
    navDashboard.classList.add('hidden'); navLogout.classList.add('hidden');
  }
  updateSidebarQuickVisibility();
}

function updateSidebarQuickVisibility(){
  if(currentUser && currentUser.role === 'Teacher' && currentView !== 'home'){
    sidebarQuick.classList.remove('hidden');
  } else {
    sidebarQuick.classList.add('hidden');
  }
}

window.addEventListener('beforeunload', () => {
  save(LS_KEYS.users, users);
  save(LS_KEYS.courses, courses);
  save(LS_KEYS.assignments, assignments);
  save(LS_KEYS.enrollments, enrollments);
  save(LS_KEYS.submissions, submissions);
});

function toast(msg, t=2000){
  const el = document.createElement('div');
  el.className = 'toast-notice';
  // small inline style for transient element ‚Äî not part of diagnostic set; acceptable
  el.style.position='fixed'; el.style.right='18px'; el.style.bottom='18px'; el.style.padding='10px 14px'; el.style.background='linear-gradient(90deg,#60a5fa,#34d399)'; el.style.color='#022'; el.style.borderRadius='10px'; el.style.fontWeight=700;
  el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), t);
}

document.getElementById('sqa-create-course').addEventListener('click', () => {
  if(!currentUser) return renderLogin();
  if(currentUser.role !== 'Teacher') return alert('Only teachers can create courses.');
  renderCreateCourse();
});
document.getElementById('sqa-create-assignment').addEventListener('click', () => {
  if(!currentUser) return renderLogin();
  if(currentUser.role !== 'Teacher') return alert('Only teachers can create assignments.');
  renderCreateAssignment();
});
document.getElementById('sqa-view-submissions').addEventListener('click', () => {
  if(!currentUser) return renderLogin();
  if(currentUser.role !== 'Teacher') return alert('Only teachers can view submissions.');
  renderAllSubmissions();
});

function setView(v){
  currentView = v;
  const layoutEl = document.querySelector('.layout');
  if(layoutEl){
    if(v === 'home') layoutEl.classList.add('home');
    else layoutEl.classList.remove('home');
  }
  updateSidebarQuickVisibility();
}

/* HOME */
function renderHome(){
  setView('home');
  main.innerHTML = '';
  const box = document.createElement('div'); box.className='home-center';
  box.innerHTML = `
    <div>
      <div class="hero-title">Gradebook</div>
      <div class="tiny muted mt-8">Elegant assignments & course portal ‚Äî Local demo</div>
    </div>
    <div class="home-actions">
      <button id="home-login" class="primary">Login</button>
      <button id="home-register" class="ghost">Register</button>
      <button id="home-courses" class="icon-btn">Browse Courses</button>
    </div>
    <div class="tiny muted mt-8">All pages keep a consistent layout. Use Register to create Teacher or Student accounts.</div>
  `;
  main.appendChild(box);
  document.getElementById('home-login').addEventListener('click', renderLogin);
  document.getElementById('home-register').addEventListener('click', renderRegister);
  document.getElementById('home-courses').addEventListener('click', renderCourses);
}

/* REGISTER */
function renderRegister(){
  setView('register');
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `
    <h2>Create account</h2>
    <form id="form-reg">
      <label>Email</label><input id="reg-email" type="email" required placeholder="name@example.com"/>
      <label>Password</label><input id="reg-pass" type="password" required placeholder="Password"/>
      <label>Role</label>
      <select id="reg-role" required>
        <option value="">Select role</option><option value="Teacher">Teacher</option><option value="Student">Student</option>
      </select>
      <div id="enroll-options" class="hidden mt-8">
        <label>Enroll into course(s) (optional)</label><div id="enroll-list" class="tiny muted"></div>
      </div>
      <div class="mt-12 flex gap-8">
        <button class="primary" type="submit">Register & Sign in</button>
        <button type="button" id="reg-back" class="icon-btn">‚Ü© Back</button>
      </div>
    </form>
  `;
  main.appendChild(c);

  const roleEl = c.querySelector('#reg-role'), enrollDiv = c.querySelector('#enroll-options'), enrollList = c.querySelector('#enroll-list');
  function refreshEnrollList(){ enrollList.innerHTML = courses.length ? courses.map(cr=>`<label style="display:block"><input type="checkbox" name="enroll" value="${cr.id}"/> ${sanitize(cr.title)} ‚Äî <span class="tiny">by ${sanitize(userById(cr.teacherId)?.email||'‚Äî')}</span></label>`).join('') : '<div class="tiny">No courses yet</div>'; }
  refreshEnrollList();
  roleEl.addEventListener('change', ()=> {
    if(roleEl.value === 'Student') enrollDiv.classList.remove('hidden'); else enrollDiv.classList.add('hidden');
  });
  c.querySelector('#reg-back').addEventListener('click', renderHome);

  c.querySelector('#form-reg').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = c.querySelector('#reg-email').value.trim().toLowerCase();
    const pass = c.querySelector('#reg-pass').value;
    const role = roleEl.value;
    if(!email || !pass || !role) return alert('Fill all fields.');
    if(users.find(u=>u.email===email)) return alert('Email already registered.');
    const hash = await sha256hex(pass);
    const u = { id: uid(), email, passwordHash: hash, role, createdAt: Date.now() };
    users.push(u); save(LS_KEYS.users, users);
    if(role === 'Student'){
      const checked = Array.from(c.querySelectorAll('input[name="enroll"]:checked')).map(n=>n.value);
      checked.forEach(cid => enrollments.push({ id: uid(), courseId: cid, studentId: u.id, enrolledAt: Date.now() }));
      save(LS_KEYS.enrollments, enrollments);
    }
    setCurrentUser({ id: u.id, email: u.email, role: u.role });
    toast('Registered & signed in');
    renderDashboard();
  });
}

/* LOGIN */
function renderLogin(){
  setView('login');
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `
    <h2>Login</h2>
    <form id="form-login">
      <label>Email</label><input id="login-email" type="email" required/>
      <label>Password</label><input id="login-pass" type="password" required/>
      <div class="mt-12 flex gap-8">
        <button class="primary" type="submit">Sign in</button>
        <button type="button" id="login-back" class="icon-btn">‚Ü© Back</button>
      </div>
    </form>
    <div class="tiny mt-10">Demo uses client-side SHA-256 hashing ‚Äî for production use server-side auth.</div>
  `;
  main.appendChild(c);
  c.querySelector('#login-back').addEventListener('click', renderHome);
  c.querySelector('#form-login').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = c.querySelector('#login-email').value.trim().toLowerCase();
    const pass = c.querySelector('#login-pass').value;
    const user = users.find(u=>u.email===email);
    if(!user) return alert('No such user');
    const hash = await sha256hex(pass);
    if(hash !== user.passwordHash) return alert('Incorrect password');
    setCurrentUser({ id: user.id, email: user.email, role: user.role });
    toast('Signed in');
    renderDashboard();
  });
}

/* LOGOUT */
function logout(){ setCurrentUser(null); toast('Signed out'); renderHome(); }

/* COURSES list ‚Äî removed enrolled count column per request */
function renderCourses(){
  setView('courses');
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `<h2>Courses</h2>`;
  if(courses.length === 0) c.innerHTML += `<p class="muted">No courses yet. Teachers can create courses from Dashboard.</p>`;
  else {
    const tbl = document.createElement('table');
    tbl.innerHTML = `<thead><tr><th>Course</th><th>Teacher</th><th>Action</th></tr></thead><tbody></tbody>`;
    courses.forEach(cr => {
      const teacher = userById(cr.teacherId);
      const tr = document.createElement('tr');
      const isEnrolled = currentUser && currentUser.role === 'Student' && enrollments.find(en => en.courseId===cr.id && en.studentId===currentUser.id);
      tr.innerHTML = `<td>${sanitize(cr.title)}</td><td>${sanitize(teacher?.email||'‚Äî')}</td><td class="minw-action">
        <button class="icon-btn" data-course="${cr.id}" data-action="open">Open</button>
        ${ currentUser && currentUser.role === 'Student' ? `<button class="icon-btn" data-course="${cr.id}" data-action="${isEnrolled? 'leave':'enroll'}">${isEnrolled? 'Leave':'Enroll'}</button>` : '' }
      </td>`;
      tbl.querySelector('tbody').appendChild(tr);
    });
    c.appendChild(tbl);

    c.addEventListener('click', (ev) => {
      const b = ev.target.closest('button[data-action]'); if(!b) return;
      const action = b.dataset.action; const cid = b.dataset.course;
      if(action === 'open') renderCoursePage(cid);
      if(action === 'enroll'){ if(!currentUser) return renderLogin(); if(currentUser.role!=='Student') return alert('Only students can enroll'); enrollments.push({ id: uid(), courseId: cid, studentId: currentUser.id, enrolledAt: Date.now() }); save(LS_KEYS.enrollments, enrollments); toast('Enrolled'); renderCourses(); }
      if(action === 'leave'){ enrollments = enrollments.filter(en => !(en.courseId===cid && en.studentId===currentUser.id)); save(LS_KEYS.enrollments, enrollments); toast('Left'); renderCourses(); }
    });
  }
  main.appendChild(c);
}

/* DASHBOARD */
function renderDashboard(){
  setView('dashboard');
  if(!currentUser) return renderLogin();
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `<h2>Dashboard</h2><div class="tiny muted">Overview</div>`;
  main.appendChild(c);

  if(currentUser.role === 'Teacher'){
    const teacherCourses = courses.filter(cr => cr.teacherId === currentUser.id);
    const sec = document.createElement('div'); sec.className='card'; sec.innerHTML = `<h3 class="no-margin">Your Courses & Actions</h3>`;
    if(teacherCourses.length === 0) sec.innerHTML += `<p class="muted">You haven't created any courses yet.</p>`;
    else {
      teacherCourses.forEach(cr => {
        const enrolled = enrollments.filter(en => en.courseId===cr.id).length;
        const box = document.createElement('div'); box.className='card';
        box.innerHTML = `<div class="flex-between">
          <div>
            <div class="fw-700">${sanitize(cr.title)}</div>
            <div class="tiny">Enrolled: ${enrolled} ‚Ä¢ Created: ${fmt(cr.createdAt)}</div>
          </div>
          <div class="flex gap-8">
            <button class="icon-btn" data-course="${cr.id}" data-action="students">üë• Students</button>
            <button class="icon-btn" data-course="${cr.id}" data-action="assignments">üìù Assignments</button>
            <button class="icon-btn" data-course="${cr.id}" data-action="marks">üè∑Ô∏è Marks</button>
            <button class="icon-btn" data-course="${cr.id}" data-action="submissions">üì• Submissions</button>
          </div>
        </div>`;
        sec.appendChild(box);
      });
    }
    const quick = document.createElement('div'); quick.className='card';
    quick.innerHTML = `<h4 class="no-margin">Quick Actions</h4><div class="mt-10 flex-col gap-8">
      <button id="qa-create-course" class="icon-btn">‚ûï Create Course</button>
      <button id="qa-create-assignment" class="icon-btn">‚ûï Create Assignment</button>
      <button id="qa-view-submissions" class="icon-btn">üì• All Submissions</button>
    </div><div class="tiny mt-8">Quick teacher actions ‚Äî only visible here.</div>`;

    main.appendChild(sec);
    main.appendChild(quick);

    document.getElementById('qa-create-course').addEventListener('click', () => renderCreateCourse());
    document.getElementById('qa-create-assignment').addEventListener('click', () => renderCreateAssignment());
    document.getElementById('qa-view-submissions').addEventListener('click', () => renderAllSubmissions());

    sec.addEventListener('click', (ev) => {
      const b = ev.target.closest('button[data-action]'); if(!b) return;
      const action = b.dataset.action; const cid = b.dataset.course;
      if(action === 'students') renderCourseStudents(cid);
      if(action === 'assignments') renderCourseAssignments(cid);
      if(action === 'marks') renderCourseMarks(cid);
      if(action === 'submissions') renderAllSubmissions();
    });

  } else {
    const studentEnrolls = enrollments.filter(en => en.studentId === currentUser.id).map(en => ({...en, course: courses.find(c=>c.id===en.courseId)})).filter(Boolean);
    const sec = document.createElement('div'); sec.className='card'; sec.innerHTML = `<h3 class="no-margin">Your Courses</h3>`;
    if(studentEnrolls.length === 0) sec.innerHTML += `<p class="muted">You are not enrolled in any courses.</p>`;
    else {
      studentEnrolls.forEach(en => {
        const box = document.createElement('div'); box.className='card';
        box.innerHTML = `<div class="flex-between">
          <div><div class="fw-700">${sanitize(en.course.title)}</div><div class="tiny">Teacher: ${sanitize(userById(en.course.teacherId)?.email||'‚Äî')}</div></div>
          <div class="flex gap-8">
            <button class="icon-btn" data-course="${en.course.id}" data-action="open">Open</button>
            <button class="icon-btn" data-course="${en.course.id}" data-action="mymarks">üè∑Ô∏è My marks</button>
          </div>
        </div>`;
        sec.appendChild(box);
      });
    }
    sec.addEventListener('click', (ev) => {
      const b = ev.target.closest('button[data-action]'); if(!b) return;
      const action = b.dataset.action; const cid = b.dataset.course;
      if(action === 'open') renderCoursePage(cid);
      if(action === 'mymarks') renderMyMarksForCourse(cid);
    });
    main.appendChild(sec);
  }
}

/* Create course (teacher-only) */
function renderCreateCourse(){
  if(!currentUser) return renderLogin();
  if(currentUser.role !== 'Teacher') return alert('Only teachers can create courses.');
  setView('create-course');
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `<h2>Create Course</h2><form id="form-course"><label>Course title</label><input id="course-title" required/><div class="mt-12 flex gap-8"><button class="primary" type="submit">Create</button><button type="button" id="course-cancel" class="icon-btn">‚Ü© Cancel</button></div></form>`;
  main.appendChild(c);
  c.querySelector('#course-cancel').addEventListener('click', renderDashboard);
  c.querySelector('#form-course').addEventListener('submit', (e) => {
    e.preventDefault();
    const title = c.querySelector('#course-title').value.trim();
    if(!title) return alert('Enter title');
    const cr = { id: uid(), title, teacherId: currentUser.id, createdAt: Date.now() };
    courses.push(cr); save(LS_KEYS.courses, courses); toast('Course created'); renderDashboard();
  });
}

/* Create assignment (teacher-only) */
function renderCreateAssignment(prefCourseId=null){
  if(!currentUser) return renderLogin();
  if(currentUser.role !== 'Teacher') return alert('Only teachers can create assignments.');
  const teacherCourses = courses.filter(cr => cr.teacherId === currentUser.id);
  if(teacherCourses.length === 0) return alert('Create a course first.');
  setView('create-assign');
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `<h2>Create Assignment</h2><form id="form-assign"><label>Title</label><input id="assign-title" required/><label>Description</label><textarea id="assign-desc"></textarea><label>Course</label><select id="assign-course" required></select><label>Deadline (optional)</label><input id="assign-deadline" type="date"/><div class="mt-12 flex gap-8"><button class="primary" type="submit">Create</button><button type="button" id="assign-cancel" class="icon-btn">‚Ü© Cancel</button></div></form>`;
  main.appendChild(c);
  const sel = c.querySelector('#assign-course'); sel.innerHTML = teacherCourses.map(cr=>`<option value="${cr.id}" ${prefCourseId===cr.id ? 'selected':''}>${sanitize(cr.title)}</option>`).join('');
  c.querySelector('#assign-cancel').addEventListener('click', renderDashboard);
  c.querySelector('#form-assign').addEventListener('submit', (e) => {
    e.preventDefault();
    const title = c.querySelector('#assign-title').value.trim(); const desc = c.querySelector('#assign-desc').value.trim(); const courseId = sel.value; const deadline = c.querySelector('#assign-deadline').value;
    if(!title || !courseId) return alert('Fill title and course');
    assignments.push({ id: uid(), courseId, title, desc, deadline: deadline||null, createdAt: Date.now() });
    save(LS_KEYS.assignments, assignments); toast('Assignment created'); renderCoursePage(courseId);
  });
}

/* Course page */
function renderCoursePage(courseId){
  setView('course');
  const cr = courses.find(c=>c.id===courseId); if(!cr) return alert('Course not found');
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `<div class="flex-between"><div><h2 class="no-margin">${sanitize(cr.title)}</h2><div class="tiny mt-8">Teacher: ${sanitize(userById(cr.teacherId)?.email||'‚Äî')}</div></div><div><button id="course-back" class="icon-btn">‚Ü© Back</button></div></div><hr class="dashed-hr">`;
  main.appendChild(c);
  document.getElementById('course-back').addEventListener('click', () => currentUser && currentUser.role === 'Teacher' ? renderDashboard() : renderCourses());

  const courseAssigns = assignments.filter(a=>a.courseId===courseId);
  const asDiv = document.createElement('div'); asDiv.innerHTML = `<h3 class="no-margin">Assignments</h3>`;
  if(courseAssigns.length === 0) asDiv.innerHTML += `<p class="muted">No assignments yet.</p>`;
  else {
    const tbl = document.createElement('table'); tbl.innerHTML = `<thead><tr><th>Title</th><th>Deadline</th><th>Action</th></tr></thead><tbody></tbody>`;
    courseAssigns.forEach(a => {
      const studentCanSubmit = currentUser && currentUser.role==='Student' && enrollments.find(en=>en.courseId===courseId && en.studentId===currentUser.id);
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${sanitize(a.title)}<div class="tiny">${sanitize(a.desc||'')}</div></td><td>${a.deadline||'‚Äî'}</td><td>${ studentCanSubmit ? `<button class="icon-btn" data-assign="${a.id}" data-act="submit">Submit</button>` : '' } <button class="icon-btn" data-assign="${a.id}" data-act="view">View</button></td>`; tbl.querySelector('tbody').appendChild(tr);
    });
    asDiv.appendChild(tbl);
    asDiv.addEventListener('click', (ev)=> {
      const b = ev.target.closest('button[data-act]'); if(!b) return;
      const act = b.dataset.act; const aid = b.dataset.assign;
      if(act === 'submit') renderSubmitAssignment(aid);
      if(act === 'view') renderViewAssignment(aid);
    });
  }
  main.appendChild(asDiv);

  if(currentUser && currentUser.role==='Teacher' && cr.teacherId === currentUser.id){
    const tools = document.createElement('div'); tools.className='card'; tools.innerHTML = `<h4 class="no-margin">Teacher Tools</h4><div class="mt-8 flex gap-8"><button id="c-add-assign" class="icon-btn">‚ûï Add assignment</button><button id="c-view-students" class="icon-btn">üë• Students</button><button id="c-view-marks" class="icon-btn">üè∑Ô∏è Marks</button></div>`;
    main.appendChild(tools);
    document.getElementById('c-add-assign').addEventListener('click', ()=> renderCreateAssignment(courseId));
    document.getElementById('c-view-students').addEventListener('click', ()=> renderCourseStudents(courseId));
    document.getElementById('c-view-marks').addEventListener('click', ()=> renderCourseMarks(courseId));
  }
}

/* Submit assignment (student) */
function renderSubmitAssignment(assignId){
  if(!currentUser) return renderLogin();
  if(currentUser.role !== 'Student') return alert('Only students can submit assignments.');
  const a = assignments.find(x=>x.id===assignId); if(!a) return alert('Assignment missing');
  if(!enrollments.find(en => en.courseId===a.courseId && en.studentId===currentUser.id)) return alert('Enroll into course first.');
  setView('submit');
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `<h2>Submit ‚Äî ${sanitize(a.title)}</h2><form id="form-sub"><label>File (max 4MB)</label><input id="file-input" type="file" accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg" required/><div class="mt-12 flex gap-8"><button class="primary" type="submit">Upload</button><button type="button" id="sub-cancel" class="icon-btn">‚Ü© Cancel</button></div></form><div class="tiny muted mt-8">Files stored as data URLs (local demo).</div>`;
  main.appendChild(c);
  c.querySelector('#sub-cancel').addEventListener('click', ()=> renderCoursePage(a.courseId));
  c.querySelector('#form-sub').addEventListener('submit', (e)=> {
    e.preventDefault();
    const f = document.getElementById('file-input').files[0];
    if(!f) return alert('Select a file');
    if(f.size > 4*1024*1024) return alert('File too big');
    const r = new FileReader();
    r.onload = (ev) => {
      submissions = submissions.filter(s => !(s.assignmentId===assignId && s.studentId===currentUser.id));
      submissions.push({ id: uid(), assignmentId: assignId, studentId: currentUser.id, fileName: f.name, fileDataURL: ev.target.result, submittedAt: Date.now(), marks: null, feedback: null, gradedBy: null, gradedAt: null });
      save(LS_KEYS.submissions, submissions); toast('Submitted'); renderCoursePage(a.courseId);
    };
    r.readAsDataURL(f);
  });
}

/* View assignment (student or teacher) */
function renderViewAssignment(assignId){
  setView('assignment');
  const a = assignments.find(x=>x.id===assignId); if(!a) return alert('Missing');
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `<h2>${sanitize(a.title)}</h2><div class="tiny muted mt-8">${sanitize(a.desc||'')}</div><div id="assign-area" class="mt-12"></div><div class="mt-12"><button class="icon-btn" id="assign-back">‚Ü© Back</button></div>`;
  main.appendChild(c); document.getElementById('assign-back').addEventListener('click', ()=> renderCoursePage(a.courseId));
  const area = document.getElementById('assign-area');

  const course = courses.find(cr => cr.id === a.courseId);
  const isTeacherOfCourse = currentUser && currentUser.role === 'Teacher' && course && course.teacherId === currentUser.id;

  if(isTeacherOfCourse){
    const subs = submissions.filter(s => s.assignmentId === assignId);
    if(subs.length === 0) area.innerHTML = `<p class="muted">No submissions yet.</p>`;
    else {
      const tbl = document.createElement('table'); tbl.innerHTML = `<thead><tr><th>Student</th><th>File</th><th>Submitted</th><th>Marks</th><th>Action</th></tr></thead><tbody></tbody>`;
      subs.forEach(s => {
        const u = userById(s.studentId);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${sanitize(u?.email||'‚Äî')}</td><td><a href="${s.fileDataURL}" target="_blank" rel="noopener noreferrer">${sanitize(s.fileName)}</a></td><td>${fmt(s.submittedAt)}</td><td>${ s.marks!==null ? sanitize(s.marks) : '<span class="muted">Not graded</span>' }</td><td><button class="icon-btn" data-sub="${s.id}" data-act="grade">‚úèÔ∏è Grade</button></td>`;
        tbl.querySelector('tbody').appendChild(tr);
      });
      area.appendChild(tbl);
      area.addEventListener('click', (ev)=> {
        const b = ev.target.closest('button[data-act]'); if(!b) return;
        if(b.dataset.act === 'grade') renderGradeSubmission(b.dataset.sub);
      });
    }
  } else {
    if(!currentUser) return renderLogin();
    const sub = submissions.find(s => s.assignmentId === assignId && s.studentId === currentUser.id);
    if(!sub) area.innerHTML = `<p class="muted">You have not submitted yet.</p>`;
    else area.innerHTML = `<div><strong>Your file:</strong> <a href="${sub.fileDataURL}" target="_blank">${sanitize(sub.fileName)}</a></div><div class="mt-8">${ sub.marks !== null ? `<div><strong>Marks:</strong> ${sanitize(sub.marks)}</div><div><strong>Feedback:</strong> ${sanitize(sub.feedback||'')}</div>` : '<div class="muted">Awaiting grading</div>' }</div>`;
  }
}

/* Grade a submission (teacher) */
function renderGradeSubmission(subId){
  if(!currentUser) return renderLogin();
  const sub = submissions.find(s=>s.id===subId); if(!sub) return alert('Missing submission');
  const assignment = assignments.find(a=>a.id===sub.assignmentId);
  const course = courses.find(c=>c.id===assignment.courseId);
  if(currentUser.role !== 'Teacher' || course.teacherId !== currentUser.id) return alert('Unauthorized');
  setView('grade');
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `<h2>Grade submission</h2><div class="tiny muted mt-8">Student: ${sanitize(userById(sub.studentId)?.email||'‚Äî')}</div><div class="mt-8"><a href="${sub.fileDataURL}" target="_blank">${sanitize(sub.fileName)}</a></div><form id="form-grade" class="mt-12"><label>Marks</label><input id="grade-marks" type="number" min="0" required/><label>Feedback</label><textarea id="grade-feedback"></textarea><div class="mt-12 flex gap-8"><button class="primary" type="submit">Save</button><button type="button" id="grade-cancel" class="icon-btn">Cancel</button></div></form>`;
  main.appendChild(c);
  c.querySelector('#grade-cancel').addEventListener('click', ()=> renderViewAssignment(sub.assignmentId));
  c.querySelector('#form-grade').addEventListener('submit', (e)=> {
    e.preventDefault();
    sub.marks = c.querySelector('#grade-marks').value.trim(); sub.feedback = c.querySelector('#grade-feedback').value.trim(); sub.gradedBy = currentUser.id; sub.gradedAt = Date.now();
    save(LS_KEYS.submissions, submissions); toast('Saved'); renderViewAssignment(sub.assignmentId);
  });
}

/* Course students (teacher-only) */
function renderCourseStudents(courseId){
  if(!currentUser) return renderLogin();
  const course = courses.find(c=>c.id===courseId); if(!course) return alert('Missing course');
  if(currentUser.role !== 'Teacher' || course.teacherId !== currentUser.id) return alert('Unauthorized');
  setView('students');
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `<h2>Students ‚Äî ${sanitize(course.title)}</h2><div class="tiny muted mt-8">Enrolled students & latest marks</div><div id="students-area" class="mt-12"></div><div class="mt-12"><button class="icon-btn" id="stu-back">‚Ü© Back</button></div>`;
  main.appendChild(c); document.getElementById('stu-back').addEventListener('click', renderDashboard);
  const area = document.getElementById('students-area');
  const enrolled = enrollments.filter(en => en.courseId === courseId);
  if(enrolled.length === 0) area.innerHTML = `<p class="muted">No students enrolled.</p>`;
  else {
    const courseAssign = assignments.filter(a=>a.courseId===courseId);
    const tbl = document.createElement('table'); let thead = '<tr><th>Student</th>';
    courseAssign.forEach(a=> thead += `<th>${sanitize(a.title)}</th>`); thead += '<th>Latest</th></tr>';
    tbl.innerHTML = `<thead>${thead}</thead><tbody></tbody>`;
    enrolled.forEach(en => {
      const u = userById(en.studentId);
      let row = `<tr><td>${sanitize(u?.email||'‚Äî')}</td>`;
      courseAssign.forEach(a => {
        const sub = submissions.find(s=>s.assignmentId===a.id && s.studentId===en.studentId);
        row += `<td>${ sub ? (sub.marks!==null ? sanitize(sub.marks) : '<span class="muted">Submitted</span>') : '<span class="muted">‚Äî</span>' }</td>`;
      });
      const graded = submissions.filter(s => s.studentId===en.studentId && courseAssign.some(a=>a.id===s.assignmentId) && s.marks !== null).sort((x,y)=> (y.gradedAt||0)-(x.gradedAt||0));
      row += `<td>${graded.length ? sanitize(graded[0].marks) : '<span class="muted">‚Äî</span>'}</td></tr>`;
      tbl.querySelector('tbody').insertAdjacentHTML('beforeend', row);
    });
    area.appendChild(tbl);
  }
}

/* Show all submissions relevant to the user */
function renderAllSubmissions(){
  if(!currentUser) return renderLogin();
  setView('all-subs');
  main.innerHTML = '';
  const card = document.createElement('div'); card.className='card';
  if(currentUser.role === 'Teacher'){
    card.innerHTML = `<h2>All submissions ‚Äî Your courses</h2><div class="tiny muted mt-8">Submissions for your courses.</div><div id="subs-area" class="mt-12"></div><div class="mt-12"><button class="icon-btn" id="subs-back">‚Ü© Back</button></div>`;
    main.appendChild(card);
    document.getElementById('subs-back').addEventListener('click', renderDashboard);
    const area = document.getElementById('subs-area');
    const yourCourseIds = courses.filter(c=>c.teacherId===currentUser.id).map(c=>c.id);
    const subs = submissions.filter(s => assignments.find(a=>a.id===s.assignmentId && yourCourseIds.includes(a.courseId)));
    if(subs.length === 0) area.innerHTML = `<p class="muted">No submissions yet.</p>`;
    else {
      const tbl = document.createElement('table'); tbl.innerHTML = `<thead><tr><th>Course</th><th>Assignment</th><th>Student</th><th>Submitted</th><th>Marks</th><th>Action</th></tr></thead><tbody></tbody>`;
      subs.forEach(s=>{
        const a = assignments.find(x=>x.id===s.assignmentId);
        const course = courses.find(c=>c.id===a.courseId);
        const u = userById(s.studentId);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${sanitize(course.title)}</td><td>${sanitize(a.title)}</td><td>${sanitize(u?.email||'‚Äî')}</td><td>${fmt(s.submittedAt)}</td><td>${s.marks!==null?sanitize(s.marks):'<span class="muted">Not graded</span>'}</td><td><button class="icon-btn" data-sub="${s.id}" data-act="grade">‚úèÔ∏è Grade</button></td>`;
        tbl.querySelector('tbody').appendChild(tr);
      });
      area.appendChild(tbl);
      area.addEventListener('click', ev=> {
        const b = ev.target.closest('button[data-act]'); if(!b) return;
        if(b.dataset.act === 'grade') renderGradeSubmission(b.dataset.sub);
      });
    }
  } else {
    card.innerHTML = `<h2>Your submissions</h2><div class="tiny muted mt-8">All submissions you made.</div><div id="subs-area" class="mt-12"></div><div class="mt-12"><button class="icon-btn" id="subs-back">‚Ü© Back</button></div>`;
    main.appendChild(card);
    document.getElementById('subs-back').addEventListener('click', renderDashboard);
    const area = document.getElementById('subs-area');
    const subs = submissions.filter(s=>s.studentId===currentUser.id);
    if(subs.length === 0) area.innerHTML = `<p class="muted">You have not submitted anything yet.</p>`;
    else {
      const tbl = document.createElement('table'); tbl.innerHTML = `<thead><tr><th>Course</th><th>Assignment</th><th>File</th><th>Submitted</th><th>Marks</th></tr></thead><tbody></tbody>`;
      subs.forEach(s=>{
        const a = assignments.find(x=>x.id===s.assignmentId);
        const course = courses.find(c=>c.id===a.courseId);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${sanitize(course.title)}</td><td>${sanitize(a.title)}</td><td><a href="${s.fileDataURL}" target="_blank">${sanitize(s.fileName)}</a></td><td>${fmt(s.submittedAt)}</td><td>${s.marks!==null?sanitize(s.marks):'<span class="muted">Awaiting</span>'}</td>`;
        tbl.querySelector('tbody').appendChild(tr);
      });
      area.appendChild(tbl);
    }
  }
}

/* Show assignments for a given course (teacher dashboard action) */
function renderCourseAssignments(courseId){
  const cr = courses.find(c=>c.id===courseId); if(!cr) return alert('Course missing');
  setView('course-assigns');
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `<h2>Assignments ‚Äî ${sanitize(cr.title)}</h2><div class="tiny muted mt-8">All assignments for this course</div><div id="assigns-area" class="mt-12"></div><div class="mt-12"><button class="icon-btn" id="assigns-back">‚Ü© Back</button></div>`;
  main.appendChild(c);
  document.getElementById('assigns-back').addEventListener('click', renderDashboard);
  const area = document.getElementById('assigns-area');
  const courseAssigns = assignments.filter(a=>a.courseId===courseId);
  if(courseAssigns.length === 0) area.innerHTML = `<p class="muted">No assignments for this course.</p>`;
  else {
    const tbl = document.createElement('table'); tbl.innerHTML = `<thead><tr><th>Title</th><th>Deadline</th><th>Action</th></tr></thead><tbody></tbody>`;
    courseAssigns.forEach(a => {
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${sanitize(a.title)}</td><td>${a.deadline||'‚Äî'}</td><td><button class="icon-btn" data-assign="${a.id}" data-act="view">View</button></td>`;
      tbl.querySelector('tbody').appendChild(tr);
    });
    area.appendChild(tbl);
    area.addEventListener('click', ev=>{
      const b = ev.target.closest('button[data-act]'); if(!b) return;
      if(b.dataset.act === 'view') renderViewAssignment(b.dataset.assign);
    });
  }
}

/* Teacher: show marks overview for a course */
function renderCourseMarks(courseId){
  const course = courses.find(c=>c.id===courseId); if(!course) return alert('Missing course');
  if(!currentUser || currentUser.role!=='Teacher' || course.teacherId !== currentUser.id) return alert('Unauthorized');
  setView('course-marks');
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `<h2>Marks ‚Äî ${sanitize(course.title)}</h2><div class="tiny muted mt-8">Overview of marks per student</div><div id="marks-area" class="mt-12"></div><div class="mt-12"><button class="icon-btn" id="marks-back">‚Ü© Back</button></div>`;
  main.appendChild(c);
  document.getElementById('marks-back').addEventListener('click', renderDashboard);
  const area = document.getElementById('marks-area');
  const courseAssign = assignments.filter(a=>a.courseId===courseId);
  const enrolled = enrollments.filter(en=>en.courseId===courseId);
  if(enrolled.length === 0){ area.innerHTML = `<p class="muted">No students enrolled.</p>`; return; }
  if(courseAssign.length === 0){ area.innerHTML = `<p class="muted">No assignments found.</p>`; return; }

  // Build table: student row, one column per assignment + average/latest
  const theadParts = ['<th>Student</th>'];
  courseAssign.forEach(a=> theadParts.push(`<th>${sanitize(a.title)}</th>`));
  theadParts.push('<th>Average</th>');
  const tbl = document.createElement('table'); tbl.innerHTML = `<thead><tr>${theadParts.join('')}</tr></thead><tbody></tbody>`;
  enrolled.forEach(en=>{
    const student = userById(en.studentId);
    const rowParts = [`<td>${sanitize(student?.email||'‚Äî')}</td>`];
    let total = 0, count = 0;
    courseAssign.forEach(a=>{
      const sub = submissions.find(s=>s.assignmentId===a.id && s.studentId===en.studentId && s.marks !== null);
      if(sub){ rowParts.push(`<td>${sanitize(sub.marks)}</td>`); total += Number(sub.marks)||0; count++; } else { rowParts.push(`<td><span class="muted">‚Äî</span></td>`); }
    });
    const avg = count ? (total / count).toFixed(1) : '‚Äî';
    rowParts.push(`<td>${avg}</td>`);
    tbl.querySelector('tbody').insertAdjacentHTML('beforeend', `<tr>${rowParts.join('')}</tr>`);
  });
  area.appendChild(tbl);
}

/* Student: view own marks for a course */
function renderMyMarksForCourse(courseId){
  if(!currentUser) return renderLogin();
  if(currentUser.role !== 'Student') return alert('Only students can view marks here.');
  const course = courses.find(c=>c.id===courseId); if(!course) return alert('Course missing');
  if(!enrollments.find(en => en.courseId===courseId && en.studentId===currentUser.id)) return alert('Enroll first.');
  setView('my-marks');
  main.innerHTML = '';
  const c = document.createElement('div'); c.className='card';
  c.innerHTML = `<h2>Your marks ‚Äî ${sanitize(course.title)}</h2><div class="tiny muted mt-8">All your submissions for this course</div><div id="mymarks-area" class="mt-12"></div><div class="mt-12"><button class="icon-btn" id="mymarks-back">‚Ü© Back</button></div>`;
  main.appendChild(c);
  document.getElementById('mymarks-back').addEventListener('click', renderDashboard);
  const area = document.getElementById('mymarks-area');
  const courseAssign = assignments.filter(a=>a.courseId===courseId);
  if(courseAssign.length === 0){ area.innerHTML = `<p class="muted">No assignments yet.</p>`; return; }
  const tbl = document.createElement('table'); tbl.innerHTML = `<thead><tr><th>Assignment</th><th>Submitted</th><th>Marks</th><th>Feedback</th></tr></thead><tbody></tbody>`;
  courseAssign.forEach(a=>{
    const sub = submissions.find(s=>s.assignmentId===a.id && s.studentId===currentUser.id);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${sanitize(a.title)}</td><td>${sub?fmt(sub.submittedAt):'<span class="muted">‚Äî</span>'}</td><td>${sub && sub.marks!==null?sanitize(sub.marks):'<span class="muted">‚Äî</span>'}</td><td>${sub?sanitize(sub.feedback||'‚Äî'):'<span class="muted">‚Äî</span>'}</td>`;
    tbl.querySelector('tbody').appendChild(tr);
  });
  area.appendChild(tbl);
}

/* Helpers */
function userById(id){ return users.find(u=>u.id===id) }

(function seed(){
  if(users.length === 0){
    sha256hex('teacherpass').then(h=>{
      const t = { id: uid(), email: 'teacher@example.com', passwordHash: h, role:'Teacher', createdAt: Date.now() };
      users.push(t); save(LS_KEYS.users, users);
      const cr = { id: uid(), title: 'Intro to Databasing', teacherId: t.id, createdAt: Date.now() }; courses.push(cr); save(LS_KEYS.courses, courses);
      Promise.all([sha256hex('stud1'), sha256hex('stud2')]).then(hs=>{
        const s1 = { id: uid(), email: 'student1@example.com', passwordHash: hs[0], role:'Student', createdAt: Date.now() };
        const s2 = { id: uid(), email: 'student2@example.com', passwordHash: hs[1], role:'Student', createdAt: Date.now() };
        users.push(s1,s2); save(LS_KEYS.users, users);
        enrollments.push({ id: uid(), courseId: cr.id, studentId: s1.id, enrolledAt: Date.now() }, { id: uid(), courseId: cr.id, studentId: s2.id, enrolledAt: Date.now() });
        save(LS_KEYS.enrollments, enrollments);
      });
    });
  }
})();
</script>
</body>
</html>
